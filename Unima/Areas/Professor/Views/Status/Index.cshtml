@{
    Layout = "/Areas/User/Views/Shared/_Layout.cshtml";
}

 <script src="https://unpkg.com/@@panzoom/panzoom/dist/panzoom.min.js"></script>

<style>
    #mapContainer {
        width: 900px; 
        height: 600px;     
        overflow: hidden;
        position: relative;
        border: 2px solid #444;
        margin: 20px auto;  
        background: white;
        border-radius: 8px;
        user-select: none;
    }

    #mapWrapper {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        gap: 20px;
        position: relative;
        width: 900px;  
        height: 600px; 
        background: #dcdbdb;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 20px;
        touch-action: none; 
    }

    #zoomControls {
        position: absolute;
        bottom: 10px;
        left: 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        z-index: 150;
    }

    .zoom-btn {
        width: 38px;
        height: 38px;
        font-size: 22px;
        font-weight: bold;
        color: white;
        background-color: #444;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: background-color 0.3s ease;
    }

    .zoom-btn:hover {
        background-color: #0d47a1;
    }

    .room-column {
        display: flex;
        flex-direction: column;
        gap: 20px;
        align-items: center;
    }

    .room-wrapper {
        width: 80px;
        height: 100px;
        position: relative;
    }

    .left-room .room { left: 0; right: unset; }
    .right-room .room { right: 0; left: unset; }

    #hallway {
        width: 60px;
        height: 100%;
        background: #a5a5a5;
        border-radius: 5px;
        box-shadow: inset 0 0 5px #a5d6a7;
    }

    .room {
        position: absolute;
        top: 0;
        width: 30px;
        height: 100px;
        border-radius: 5px;
        cursor: pointer;
        transition: width 0.6s ease;
        background-color: #66bb6a;
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        align-items: center;
        flex-direction: column;
        overflow: visible;
        color: white;
        font-weight: bold;
        font-size: 14px;
        user-select: none;
    }

    .room.expanded {
        width: 200px;
        box-shadow: 0 0 8px #444;
        z-index: 10;
    }

    .teacher-name {
        writing-mode: vertical-rl;
        transform: rotate(180deg);
        pointer-events: none;
        white-space: nowrap;
        text-align: center;
        margin: auto !important;
    }

    .room.expanded .room-details {
        display: block;
        color: black;
        font-weight: normal;
        writing-mode: horizontal-tb;
        transform: none;
        text-align: center;
    }

    .room.expanded .teacher-name {
        font-weight: bold;
        font-size: 14px;
        text-shadow: 0 0 3px #1976d2;
        transition: all 0.3s ease;
        transform: rotate(-90deg);
        position: absolute;
        right: 30px;
        top: 30px;
    }


    .room-details {
        padding-top: 12px;
        display: none;
    }

    .img-detail{
        position: absolute;
        background: url("/Images/icons8-user-32.png") no-repeat center center;
        color: #000;
        top: 2px;
        right: 12px;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        background-color: #dcdbdb;
    }

    .details-status {
        margin-bottom: 8px;
        margin-left: -70px;
    }

    .details-button {
        background-color: #1976d2;
        position: absolute;
        bottom: 0;
        left: 0;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: 60%;
        height: 25px;
        font-size: 14px;
        transition: background-color 0.3s ease;
    }

    .details-button:hover {
        background-color: #0d47a1;
    }

    .status-present { background-color: #66bb6a; }
    .status-absent { background-color: #ef5350; }
    .status-inmeeting { background-color: #81c784; }

    #entrance {
        position: absolute;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        width: 24px;
        height: 24px;
        background: #3949ab;
        border-radius: 50%;
        z-index: 100;
    }

    #entrance-label {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 14px;
        text-align: center;
        color: #000;
        z-index: 100;
    }

    #routeCanvas {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
        z-index: 50;
    }
</style>

<div id="mapContainer">
    <div id="mapWrapper">
        <div class="room-column" id="leftColumn">
            <div class="room-wrapper left-room">
                <div class="room status-inmeeting" data-room-id="101" data-teacher="دکتر احمدی" data-status="در حال جلسه" tabindex="0">
                    <div class="teacher-name">دکتر احمدی</div>
                    <div class="room-details">
                        <div class="img-detail align-items-center"></div>
                        <div class="details-status">
                            <ul>
                                <li>09152552525</li>
                                <li>کامپیوتر</li>
                                <li>حاضر</li>
                            </ul>
                        </div>
                        <button class="details-button">نمایش مسیر</button>
                    </div>
                </div>
            </div>
            <div class="room-wrapper left-room">
                <div class="room status-present" data-room-id="103" data-teacher="مهندس رضایی" data-status="حاضر" tabindex="0">
                    <div class="teacher-name">مهندس رضایی</div>
                    <div class="room-details">
                        <button class="details-button">نمایش مسیر</button>
                    </div>
                </div>
            </div>
            <div class="room-wrapper left-room">
                <div class="room status-absent" data-room-id="105" data-teacher="دکتر کاظمی" data-status="غایب" tabindex="0">
                    <div class="teacher-name">دکتر کاظمی</div>
                    <div class="room-details">
                        <button class="details-button">نمایش مسیر</button>
                    </div>
                </div>
            </div>
            <div class="room-wrapper left-room">
                <div class="room status-present" data-room-id="107" data-teacher="دکتر نوری" data-status="حاضر" tabindex="0">
                    <div class="teacher-name">دکتر نوری</div>
                    <div class="room-details">
                        <button class="details-button">نمایش مسیر</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="hallway"></div>

        <div class="room-column" id="rightColumn">
            <div class="room-wrapper right-room">
                <div class="room status-absent" data-room-id="102" data-teacher="مهندس صادقی" data-status="غایب" tabindex="0">
                    <div class="teacher-name">مهندس صادقی</div>
                    <div class="room-details">
                        <button class="details-button">نمایش مسیر</button>
                    </div>
                </div>
            </div>
            <div class="room-wrapper right-room">
                <div class="room status-present" data-room-id="104" data-teacher="دکتر جمشیدی" data-status="حاضر" tabindex="0">
                    <div class="teacher-name">دکتر جمشیدی</div>
                    <div class="room-details">
                        <button class="details-button">نمایش مسیر</button>
                    </div>
                </div>
            </div>
            <div class="room-wrapper right-room">
                <div class="room status-inmeeting" data-room-id="106" data-teacher="دکتر رحیمی" data-status="در حال جلسه" tabindex="0">
                    <div class="teacher-name">دکتر رحیمی</div>
                    <div class="room-details">
                        <button class="details-button">نمایش مسیر</button>
                    </div>
                </div>
            </div>
            <div class="room-wrapper right-room">
                <div class="room status-present" data-room-id="108" data-teacher="مهندس رستمی" data-status="حاضر" tabindex="0">
                    <div class="teacher-name">مهندس رستمی</div>
                    <div class="room-details">
                        <button class="details-button">نمایش مسیر</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="entrance"></div>
        <div id="entrance-label">ورودی</div>

    </div>
    <div id="zoomControls">
        <button id="zoomIn" class="zoom-btn" title="بزرگنمایی">+</button>
        <button id="zoomOut" class="zoom-btn" title="کوچک نمایی">−</button>
    </div>
</div>

<script>
    const rooms = document.querySelectorAll('.room');
    let expandedRoom = null;

    rooms.forEach(room => {
        room.addEventListener('click', () => {
            if (expandedRoom && expandedRoom !== room) collapseRoom(expandedRoom);
            room.classList.toggle('expanded');
            expandedRoom = room.classList.contains('expanded') ? room : null;
            clearPath();
        });

        room.querySelector('.details-button').addEventListener('click', e => {
            e.stopPropagation();
            drawPathToRoom(room);
        });
    });

    function drawPathToRoom(room) {
        clearPath();

        const mapWrapper = document.getElementById('mapWrapper');
        const entrance = document.getElementById('entrance');
        const mapRect = mapWrapper.getBoundingClientRect();
        const entranceRect = entrance.getBoundingClientRect();
        const roomRect = room.getBoundingClientRect();

        const startX = entranceRect.left + entranceRect.width / 2 - mapRect.left;
        const startY = entranceRect.top + entranceRect.height / 2 - mapRect.top;

        const wrapper = room.closest('.room-wrapper');
        const isLeft = wrapper.classList.contains('left-room');

        const targetX = isLeft
            ? roomRect.left - mapRect.left
            : roomRect.right - mapRect.left;

        const targetY = roomRect.top + roomRect.height / 2 - mapRect.top;

        const ctx = getOrCreateCanvasCtx();
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(startX, targetY);
        ctx.lineTo(targetX, targetY);
        ctx.strokeStyle = '#1976d2';
        ctx.lineWidth = 4;
        ctx.setLineDash([6, 4]);
        ctx.stroke();
    }

    function getOrCreateCanvasCtx() {
        const mapWrapper = document.getElementById('mapWrapper');
        let canvas = document.getElementById('routeCanvas');

        if (!canvas) {
            canvas = document.createElement('canvas');
            canvas.id = 'routeCanvas';
            mapWrapper.appendChild(canvas);
        }

        canvas.width = mapWrapper.clientWidth;
        canvas.height = mapWrapper.clientHeight;

        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return ctx;
    }

    function clearPath() {
        const canvas = document.getElementById('routeCanvas');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    }

    function collapseRoom(room) {
        room.classList.remove('expanded');
        if (expandedRoom === room) expandedRoom = null;
    }

    const mapContainer = document.getElementById('mapContainer');
    const panzoomInstance = Panzoom(document.getElementById('mapWrapper'), {
        maxScale: 3,
        minScale: 0,
        contain: 'outside',
    });

    mapContainer.addEventListener('wheel', panzoomInstance.zoomWithWheel);

    document.getElementById('zoomIn').addEventListener('click', () => panzoomInstance.zoomIn());
    document.getElementById('zoomOut').addEventListener('click', () => panzoomInstance.zoomOut());
</script>
