@using Unima.Areas.User.Models.ViewModels

@model IEnumerable<AppointmentViewModel>

@{
	Layout = "/Areas/User/Views/Shared/_Layout.cshtml";
}

<style>
	.accordion-item {
		border-bottom: 1px solid #e0e0e0;
		border-radius: 0 !important;
		border-left: none;
		border-right: none;
		border-top: none;
	}

		.accordion-item:first-of-type {
			border-top-left-radius: 0 !important;
			border-top-right-radius: 0 !important;
		}

		.accordion-item:last-of-type {
			border-bottom-left-radius: 0 !important;
			border-bottom-right-radius: 0 !important;
		}

	.badge:empty {
		display: block;
	}

	.accordion-button {
		display: grid !important;
		grid-template-columns: 40px 2fr 4fr 1.5fr 40px !important;
		gap: 1rem;
		align-items: center;
		padding: 1rem 1.5rem;
	}

		.accordion-button:not(.collapsed) {
			background-color: #e8f0fe;
			box-shadow: none;
		}

			.accordion-button.collapsed::after,
			.accordion-button:not(.collapsed):after {
				display: none;
			}

	.student-info,
	.subject-info {
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		font-weight: 500;
	}

	.student-info {
		font-weight: 700;
	}

	.status-indicator .badge {
		width: 12px;
		height: 12px;
		padding: 0;
		border-radius: 50%;
	}

	.star-action {
		text-align: center;
		font-size: 1.1rem;
		color: #757575;
		cursor: pointer;
		transition: color 0.2s ease-in-out;
	}

	.accordion-body {
		background-color: #ffffff;
		padding: 1.5rem 2rem;
		border-top: 1px solid #e0e0e0;
	}

	.body-actions {
		border-top: 1px solid #e0e0e0;
		padding-top: 1rem;
		margin-top: 1.5rem;
	}

		.body-actions .btn {
			flex-grow: 1;
		}

	.reply-form,
	.rejection-form {
		display: none;
		margin-top: 1.5rem;
		padding-top: 1.5rem;
		border-top: 1px dashed #ccc;
	}

	.request-description {
		background-color: #f8f9fa;
		padding: 1rem;
		border-radius: 8px;
		margin-bottom: 1.5rem;
	}

	.accordion-item .fa-solid.fa-star {
		display: none;
	}

	.accordion-item .fa-regular.fa-star {
		display: inline-block;
	}

	.accordion-item.starred .fa-solid.fa-star {
		display: inline-block;
		color: #fbbc05;
	}

	.accordion-item.starred .fa-regular.fa-star {
		display: none;
	}

	.filter-tabs .col-3 {
		padding-left: 5px;
		padding-right: 5px;
	}

	.tab-item {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		text-align: center;
		padding: 0.75rem 0.5rem;
		border: 1px solid #dee2e6;
		border-radius: 0.5rem;
		cursor: pointer;
		transition: all 0.2s ease-in-out;
		background-color: #fff;
		color: #495057;
	}

		.tab-item:hover {
			background-color: #f8f9fa;
			border-color: #adb5bd;
		}

		.tab-item.active {
			background-color: #f1efec;
			border-color: #dda853;
			color: #dda853;
			font-weight: 600;
		}

		.tab-item .tab-icon {
			font-size: 1.5rem;
			margin-bottom: 0.35rem;
		}

	.tab-label-group {
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.tab-item .tab-text {
		font-weight: 600;
		display: block;
	}

	.tab-item .tab-counter {
		margin-right: 6px;
		padding-top: 3px;
		padding-right: -1px;
		background-color: #6c757d;
		color: #fff;
		border-radius: 50%;
		font-size: 0.75rem;
		width: 22px;
		height: 22px;
		display: flex;
		align-items: center;
		justify-content: center;
		line-height: 1;
	}

	.tab-item.active .tab-counter {
		background-color: #dda853;
	}

	#no-requests-message {
		display: none;
	}

	.messages-container {
		background-color: #fff;
		border: 1px solid #f0f0f0;
		border-radius: 0.75rem;
		box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
		padding: 0.5rem;
		max-height: 65vh;
		overflow-y: auto;
		position: relative;
		min-height: 75px;
	}

	#filter-no-results-message {
		display: none;
	}
</style>

<div class="row filter-tabs g-2 my-4">
	<div class="col-3">
		<div class="tab-item active" data-filter="all">
			<i class="fas fa-inbox tab-icon"></i>
			<div class="tab-label-group">
				<span class="tab-text">همه</span>
				<div id="all-count" class="tab-counter">0</div>
			</div>
		</div>
	</div>
	<div class="col-3">
		<div class="tab-item" data-filter="starred">
			<i class="fas fa-star tab-icon"></i>
			<div class="tab-label-group">
				<span class="tab-text">ستاره‌دار</span>
				<div id="starred-count" class="tab-counter">0</div>
			</div>
		</div>
	</div>
	<div class="col-3">
		<div class="tab-item" data-filter="accepted">
			<i class="fas fa-check-circle tab-icon"></i>
			<div class="tab-label-group">
				<span class="tab-text">تایید شده</span>
				<div id="accepted-count" class="tab-counter">0</div>
			</div>
		</div>
	</div>
	<div class="col-3">
		<div class="tab-item" data-filter="rejected">
			<i class="fas fa-times-circle tab-icon"></i>
			<div class="tab-label-group">
				<span class="tab-text">رد شده</span>
				<div id="rejected-count" class="tab-counter">0</div>
			</div>
		</div>
	</div>
</div>

<section class="row">
	<div class="container my-3">

		<div id="no-requests-message" class="text-center">
			<h4 class="text-muted">برای شما تایم رزروی صورت نگرفته است</h4>
		</div>

		<div class="messages-container">
			<div id="filter-no-results-message" class="text-center p-5">
				<h5 class="text-muted"></h5>
			</div>
			<div class="accordion" id="requestsAccordion">
				@if (Model is not null)
				{
					foreach (AppointmentViewModel appointment in Model)
					{
						<div class="accordion-item @(appointment.IsStarred ? "starred" : string.Empty)" data-id="@appointment.Id" data-status="pending">
							<h2 class="accordion-header p-0" id="headingOne">
								<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse@(appointment.Id)" aria-expanded="false" aria-controls="collapse@(appointment.Id)">
									<div class="star-action">
										<i class="fa-regular fa-star"></i><i class="fa-solid fa-star"></i>
									</div>
									<div class="student-info"><i class="fas fa-user-circle me-2 text-muted"></i> @appointment.SenderFullName</div>
									<div class="subject-info"><strong>موضوع:</strong> @appointment.Topic</div>
									<div class="date-info"><span class="badge bg-light text-dark">@appointment.Date</span></div>
									<div class="status-indicator"><span class="badge @(appointment.Status == Unima.Dal.Enums.AppointmentStatus.Waiting ? "bg-warning" : appointment.Status == Unima.Dal.Enums.AppointmentStatus.Accept ? "bg-success" : "bg-danger")" title="در انتظار پاسخ"></span></div>
								</button>
							</h2>
							<div id="collapse@(appointment.Id)" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#requestsAccordion">
								<div class="accordion-body">
									<div class="row mb-3">
										<div class="col-md-6">
											<p><strong><i class="fas fa-user ms-2 text-muted"></i>نام کاربر:</strong> @appointment.SenderFullName</p>
											<p><strong><i class="fas fa-user-graduate ms-2 text-muted"></i>شماره دانشجویی:</strong> @appointment.SenderUsername</p>
											<p><strong><i class="fas fa-calendar-alt ms-2 text-muted"></i>تاریخ ارسال:</strong> @appointment.RequestSentOn</p>
											<p><strong><i class="fas fa-map-marker-alt text-muted ms-2"></i>مکان جلسه:</strong> @appointment.LocationTitle</p>
										</div>
										<div class="col-md-6">
											<p><strong><i class="fas fa-calendar-alt text-muted ms-2"></i>تاریخ رزرو:</strong> @appointment.Date</p>
											<p><strong><i class="fas fa-clock text-muted ms-2"></i>ساعت:</strong> @appointment.Time</p>
											<p><strong><i class="fas fa-hourglass-half text-muted ms-2"></i>مدت زمان:</strong> @appointment.Duration دقیقه</p>
										</div>
									</div>
									<div class="request-description">
										<p class="mb-0"><strong>توضیحات:</strong> @appointment.Description</p>
										<a href="#" class="btn btn-primary btn-sm mt-3"><i class="fas fa-download me-1"></i> دانلود فایل</a>
									</div>
									<div class="body-actions">
										<div class="d-flex gap-5">
											<button class="btn btn-success btn-accept"><i class="fas fa-check ms-1"></i>تایید</button>
											<button class="btn btn-danger btn-reject"><i class="fas fa-times ms-1"></i>رد</button>
										</div>
									</div>
									<div class="rejection-form">
										<h6><i class="fas fa-comment-slash ms-2"></i>علت رد درخواست</h6>
										<textarea class="form-control" rows="4" placeholder="لطفا دلیل رد درخواست را بنویسید..."></textarea>
										<div class="d-flex justify-content-end gap-2 mt-2">
											<button class="btn btn-light btn-cancel-rejection">لغو</button>
											<button class="btn btn-danger btn-confirm-rejection">تایید رد</button>
										</div>
									</div>
								</div>
							</div>
						</div>
					}
				}
			</div>
		</div>
	</div>
</section>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
	$(document).ready(function () {

		function updateCounters() {
			const allCount = $('.accordion-item').length;
			const starredCount = $('.accordion-item.starred').length;
			const acceptedCount = $('.accordion-item[data-status="accepted"]').length;
			const rejectedCount = $('.accordion-item[data-status="rejected"]').length;

			$('#all-count').text(allCount);
			$('#starred-count').text(starredCount);
			$('#accepted-count').text(acceptedCount);
			$('#rejected-count').text(rejectedCount);

			if (allCount === 0) {
				$('.messages-container').hide();
				$('.filter-tabs').hide();
				$('#no-requests-message').show();
			} else {
				$('.messages-container').show();
				$('.filter-tabs').show();
				$('#no-requests-message').hide();
			}
		}

		function updateStatus(item, status) {
			const statusBadge = item.find(".status-indicator .badge");
			statusBadge.removeClass("bg-warning bg-success bg-danger");
			item.attr("data-status", status);

			if (status === "accepted") {
				statusBadge.addClass("bg-success").attr("title", "تایید شده");
			} else if (status === "rejected") {
				statusBadge.addClass("bg-danger").attr("title", "رد شده");
			}

			item.find(".body-actions .btn").prop("disabled", true);
			updateCounters();
		}

		$(".star-action").on("click", function (e) {
			e.stopPropagation();
			var item = $(this).closest(".accordion-item")
			item.toggleClass("starred");
			var id = item[0].dataset.id;
			if(id){
			fetch(`/Appointment/StarUnstar/${id}`, {
				method: "POST",
			})
				.then(response => {
					if(response.ok){
						updateCounters();
					   $('.tab-item.active').trigger('click');
					}
				})
				.catch(error => {
				  console.error("Error:", error);
				});
			}
		});

		$(".tab-item").on("click", function (e) {
			e.preventDefault();

			$(".tab-item").removeClass("active");
			const currentTab = $(this);
			currentTab.addClass("active");

			const filter = currentTab.data("filter");
			let visibleItemsCount = 0;

			$('.accordion-item').hide();

			let itemsToShow;

			if (filter === 'all') {
				itemsToShow = $('.accordion-item');
			} else if (filter === 'starred') {
				itemsToShow = $('.accordion-item.starred');
			} else {
				itemsToShow = $(`.accordion-item[data-status="${filter}"]`);
			}

			visibleItemsCount = itemsToShow.length;

			itemsToShow.slideDown();

			const emptyMessageDiv = $('#filter-no-results-message');
			if (visibleItemsCount === 0 && $('.accordion-item').length > 0) {
				let message = "";
				switch(filter) {
					case 'starred':
						message = "هیچ پیام ستاره‌داری وجود ندارد.";
						break;
					case 'accepted':
						message = "هیچ پیام تایید شده‌ای وجود ندارد.";
						break;
					case 'rejected':
						message = "هیچ پیام رد شده‌ای وجود ندارد.";
						break;
				}
				emptyMessageDiv.find('h5').text(message);
				emptyMessageDiv.show();
			} else {
				emptyMessageDiv.hide();
			}
		});


		$(".btn-accept").on("click", function () {
			const item = $(this).closest(".accordion-item");
			updateStatus(item, "accepted");
		});

		$(".btn-reply").on("click", function () {
			const accordionBody = $(this).closest(".accordion-body");
			accordionBody.find(".rejection-form").slideUp();
			accordionBody.find(".reply-form").slideToggle();
		});

		$(".btn-reject").on("click", function () {
			const accordionBody = $(this).closest(".accordion-body");
			accordionBody.find(".reply-form").slideUp();
			accordionBody.find(".rejection-form").slideToggle();
		});

		$(".btn-cancel-rejection").on("click", function () {
			$(this).closest(".rejection-form").slideUp();
		});

		$(".btn-confirm-rejection").on("click", function () {
			const item = $(this).closest(".accordion-item");
			updateStatus(item, "rejected");
			$(this).closest(".rejection-form").slideUp();
		});

		updateCounters();
		$('.tab-item.active').trigger('click');
	});
</script>